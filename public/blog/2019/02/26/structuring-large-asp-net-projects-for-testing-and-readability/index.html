<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Structuring large ASP.NET Core projects for testing and readability</h1><p class="post-meta">Posted by <a href="/blog/authors/dgiddins.html">dgiddins</a>, 26 February 2019 · <a href="/blog/categories/Testing/" class="tag post-meta">Testing</a> · <a href="/blog/categories/DotNetCore/" class="tag post-meta">DotNetCore</a> · <a href="/blog/categories/ASP-Net/" class="tag post-meta">ASP.Net</a> · <a href="/blog/categories/NUnit/" class="tag post-meta">NUnit</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>This is a continuation of the post <a href="/blog/2019/01/28/testing-an-api-in-memory-in-asp-net-core/">Testing an API In Memory in ASP.NET Core</a> where I described in detail how to test an ASP.NET Core API end-to-end in an isolated, repeatable fashion. This is a shorter post that discusses an approach to structuring your project that should make it easier to test and develop.</p>
<p>Oh and there are lots of code samples again!</p>
<h2 id="Where-we-left-off"><a href="#Where-we-left-off" class="headerlink" title="Where we left off"></a>Where we left off</h2><p>In my previous post I described how to get a truly isolated in-memory instance of a ASP.NET Core API configured in a test harness to perform repeatable tests. We created an InMemoryStartup class (for configuring the site for testing) and an InMemoryApi class (for encapsulating Test Doubles and setting up the API). I did not go into detail about the content of either of the Start up classes which is what I intend to address here.</p>
<p>Much of the complexity from this kind of testing derives from having to maintain two configuration classes and keeping them in sync correctly. It is all too easy for strange bugs to creep in and go unnoticed when differences are not correctly replicated. </p>
<p>The solution to this is actually quite straightforward which is to create shared configuration classes that can be specialised for your in-memory testing situation. My solution involves creating two configuration classes, one for each of the two methods that are implemented by convention in your regular Startup.cs and the two methods of the IStartup interface. These are:</p>
<ul>
<li>WebAppConfigurator - for the Configure method of Startup</li>
<li>ServiceCollectionInstallerRunner - for the ConfigureServices method of Startup</li>
</ul>
<p>Both of these classes will have in-memory versions of themselves implemented as extension classes - we will come on to this later. </p>
<h2 id="WebAppConfigurator"><a href="#WebAppConfigurator" class="headerlink" title="WebAppConfigurator"></a>WebAppConfigurator</h2><p>I know, not the best name but it describes what we are doing here and it’s hard to name configuration and boot strapping classes properly. This class will look roughly as follows</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebAppConfigurator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebAppConfigurator</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Configuration = configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory, IApplicationLifetime appLifeTime, IServiceProvider serviceProvider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//This is all just an example of the configuration steps you might need.</span></span><br><span class="line">        ConfigureLogger(app, loggerFactory, serviceProvider); </span><br><span class="line">        ConfigureSwagger(app);</span><br><span class="line"></span><br><span class="line">        ConfigureShutdown(app, appLifeTime);</span><br><span class="line">        ConfigurePostStartup(app, appLifeTime);</span><br><span class="line"></span><br><span class="line">        LocaleConfiguration.ConfigureRequestLocalization(app);</span><br><span class="line">        app.UseResponseCompression();</span><br><span class="line">        app.UseMvc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ConfigureLogger</span>(<span class="params">(IApplicationBuilder app, ILoggerFactory loggerFactory, IServiceProvider serviceProvider</span>) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//configure the logger</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ConfigureSwagger</span>(<span class="params">(IApplicationBuilder app</span>) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//configure swagger</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This would be called from your startup class as follows</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IHostingEnvironment env</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        BuildConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder applicationBuilder, IHostingEnvironment hostingEnvironment, ILoggerFactory loggerFactory, IApplicationLifetime appLifeTime, IServiceProvider serviceProvider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> configurator = <span class="keyword">new</span> WebAppConfigurator(Configuration);</span><br><span class="line">        configurator.Configure(applicationBuilder, hostingEnvironment, loggerFactory, appLifeTime, serviceProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//more to follow...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">            .AddEnvironmentVariables();</span><br><span class="line"></span><br><span class="line">        Configuration = builder.Build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice that compared to the Startup class in my first post, the Configure method has additional parameters. The number of parameters you define in your Startup.Configure() method is flexible depending on what you require for your configuration. In my particular case I required all of the listed parameters. This caused some difficulties when implementing the IStartup interface whose Configure method only takes an IApplicationBuilder.</p>
<p>The next step is to create an in-memory version of the WebAppConfigurator which derives from the WebAppConfigurator. It will then override implementations of any virtual methods in this class which we use to encapsulate configuration steps.</p>
<p>This would look as follows:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryWebAppConfigurator</span> : <span class="title">WebAppConfigurator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryWebAppConfigurator</span>(<span class="params">IConfiguration configuration</span>) : <span class="title">base</span>(<span class="params">configuration</span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ConfigureSwagger</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ConfigureLogger</span>(<span class="params">IApplicationBuilder app, ILoggerFactory loggerFactory, IServiceProvider serviceProvider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example we don’t really want swagger running in the test harness nor do we want logging (which in our case is writing to Redis) and so the configuration methods do nothing. The configuration steps that are encapsulated with this method are entirely up too you and depends on your particular use case.</p>
<p>The final step is to now call this from our InMemoryStartup</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryStartup</span> : <span class="title">IStartup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryStartup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        BuildConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//todo</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> configurator = <span class="keyword">new</span> InMemoryWebAppConfigurator(Configuration);</span><br><span class="line">        <span class="keyword">var</span> nullLoggerFactory = <span class="keyword">new</span> NullLoggerFactory();</span><br><span class="line">        configurator.Configure(</span><br><span class="line">            app,</span><br><span class="line">            <span class="keyword">new</span> HostingEnvironment()</span><br><span class="line">            &#123;</span><br><span class="line">                ApplicationName = <span class="string">"Test Harness"</span>,</span><br><span class="line">                EnvironmentName = <span class="string">"Test"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            nullLoggerFactory,</span><br><span class="line">            <span class="keyword">new</span> ApplicationLifetime(<span class="keyword">new</span> Logger&lt;ApplicationLifetime&gt;(<span class="keyword">new</span> NullLoggerFactory())), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">            .AddEnvironmentVariables();</span><br><span class="line">        Configuration = builder.Build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice in the Configure method that I have constructed a HostingEnvironment type and provided some dummy data as well as passing in a NullLoggerFactory and an ApplicationLifetime type. In my case I did not need to pass the IServiceProvider so I passed null, but you can pass it after it is constructed in your ConfigureServices method.</p>
<h2 id="ServiceCollectionInstallerRunner"><a href="#ServiceCollectionInstallerRunner" class="headerlink" title="ServiceCollectionInstallerRunner"></a>ServiceCollectionInstallerRunner</h2><p>The next step is to configure all of your dependencies. In ASP.NET WebApi I tended to leverage 3rd party dependency injection containers such as Castle Windsor, but in ASP.NET Core I find the built-in resolver works perfectly well; at least with a few additions. </p>
<p>The first of these I would recommend you use is <a href="https://github.com/khellang/Scrutor" target="_blank" rel="noopener">Scrutor</a>. This provides two extension methods to the IServiceCollection type; Scan and Decorate. Scan allows you to use convention-based registration, meaning you don’t have to register each type individually. Decorate allows for type decoration. </p>
<p>The second addition is actually something that you can easily add yourself by copying the code below.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IServiceCollectionInstaller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ConfigureService</span>(<span class="params">IServiceCollection services, IConfiguration configuration</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServiceCollectionInstallerRunner</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services, IConfiguration configuration</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> installers = GetServiceInstallers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (IServiceCollectionInstaller installer <span class="keyword">in</span> installers)</span><br><span class="line">        &#123;</span><br><span class="line">            installer.ConfigureService(services, configuration);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> IEnumerable&lt;IServiceCollectionInstaller&gt; <span class="title">GetServiceInstallers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Assembly assembly = Assembly.GetAssembly(<span class="keyword">typeof</span>(ServiceCollectionInstallerRunner));</span><br><span class="line"></span><br><span class="line">        IEnumerable&lt;Type&gt; installerTypes = <span class="keyword">from</span> type <span class="keyword">in</span> assembly.GetTypes()</span><br><span class="line">            <span class="function"><span class="keyword">where</span> <span class="title">typeof</span>(<span class="params">IServiceCollectionInstaller</span>).<span class="title">IsAssignableFrom</span>(<span class="params">type</span>) &amp;&amp; type !</span>= <span class="keyword">typeof</span>(IServiceCollectionInstaller)</span><br><span class="line">            <span class="keyword">select</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (Type installerType <span class="keyword">in</span> installerTypes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> constructors = installerType.GetConstructors();</span><br><span class="line">            <span class="keyword">if</span> (constructors.Any(constructor =&gt; constructor.GetParameters().Length &gt; <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoParameterlessConstructorException(installerType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        IEnumerable&lt;IServiceCollectionInstaller&gt; installers = installerTypes.Select(type =&gt; (IServiceCollectionInstaller) Activator.CreateInstance(type));</span><br><span class="line">        <span class="keyword">return</span> installers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NoParameterlessConstructorException</span> : <span class="title">Exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NoParameterlessConstructorException</span>(<span class="params">Type installerType</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params"><span class="string">$"Constructor containing parameters not allowed in IServiceCollectionInstaller. Unable to create type <span class="subst">&#123;installerType.Name&#125;</span>"</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What this provides is very similar to Castle Windsor’s IWindsorInstaller interface which lets you define type registration classes for different areas of your application. </p>
<p>The way I prefer to use this is to divide my API project into areas such as logging, monitoring and application-specific areas, and then in each folder have an implementation of IServiceCollectionInstaller that will take care of configuring all the types in that folder. This keeps the configuration as close as possible to the parts being configured. For example:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MasstransitServiceInstaller</span> : <span class="title">IServiceCollectionInstaller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureService</span>(<span class="params">IServiceCollection services, IConfiguration configuration</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        services.AddSingleton&lt;IBus&gt;(CreateBus);</span><br><span class="line">        services.AddSingleton&lt;IEventSender, EventSender&gt;();</span><br><span class="line">        services.Decorate&lt;IEventSender, EventSenderFailureHandler&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBus <span class="title">CreateBus</span>(<span class="params">IServiceProvider provider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> configuration = provider.GetService&lt;IRabbitMqConfiguration&gt;();</span><br><span class="line"></span><br><span class="line">        IBusControl busControl = Bus.Factory.CreateUsingRabbitMq(sbc =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> hostAddress = <span class="keyword">new</span> Uri(configuration.RabbitMqUrl);</span><br><span class="line">            <span class="keyword">var</span> host = sbc.Host(hostAddress, h =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                h.Username(<span class="string">"guest"</span>);</span><br><span class="line">                h.Password(<span class="string">"guest"</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            sbc.UseJsonSerializer();</span><br><span class="line">            sbc.ReceiveEndpoint(host, <span class="string">"HA-OT.api-messages"</span>, c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.PrefetchCount = <span class="number">50</span>;</span><br><span class="line">                c.SetQueueArgument(<span class="string">"ha"</span>, <span class="number">1</span>);</span><br><span class="line">                c.SetQueueArgument(<span class="string">"tx"</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> busControl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example we are setting up MassTransit with RabbitMQ along with our own abstractions on top of the IBus and a decorator for that type to handle send failures.</p>
<p>This makes dependency configuration easy to follow and locate, and is quite rational instead of one giant configuration vomiting dependency configuration code over hundreds of lines in your Startup.cs file.</p>
<p>We can then complete our Startup class as follows</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IHostingEnvironment env</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        BuildConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder applicationBuilder, IHostingEnvironment hostingEnvironment, ILoggerFactory loggerFactory, IApplicationLifetime appLifeTime, IServiceProvider serviceProvider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> configurator = <span class="keyword">new</span> WebAppConfigurator(Configuration);</span><br><span class="line">        configurator.Configure(applicationBuilder, hostingEnvironment, loggerFactory, appLifeTime, serviceProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> installerRunner = <span class="keyword">new</span> ServiceCollectionInstallerRunner();</span><br><span class="line">        installerRunner.ConfigureServices(services, Configuration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">            .AddEnvironmentVariables();</span><br><span class="line"></span><br><span class="line">        Configuration = builder.Build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The next step is to make it possible to override the services as configured for running normally to work for our in-memory tests. For this we need to create an in-memory version of the ServiceCollectionInstallerRunner and a new interface that defines overrides of the Service Collection Installer. The code is shared below.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IServiceCollectionInstallerOverride</span> : <span class="title">IServiceCollectionInstaller</span></span><br><span class="line">&#123;</span><br><span class="line">    Type InstallerOverridden &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryServiceCollectionRunner</span> : <span class="title">ServiceCollectionInstallerRunner</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> List&lt;IServiceCollectionInstallerOverride&gt; _serviceCollectionInstallerOverrides;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryServiceCollectionRunner</span>(<span class="params">List&lt;IServiceCollectionInstallerOverride&gt; serviceCollectionInstallerOverrides</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _serviceCollectionInstallerOverrides = serviceCollectionInstallerOverrides;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IEnumerable&lt;IServiceCollectionInstaller&gt; <span class="title">GetServiceInstallers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        IEnumerable&lt;IServiceCollectionInstaller&gt; defaultList = <span class="keyword">base</span>.GetServiceInstallers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> listWithOverrides = <span class="keyword">new</span> List&lt;IServiceCollectionInstaller&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (IServiceCollectionInstaller defaultInstaller <span class="keyword">in</span> defaultList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> installerOverride =</span><br><span class="line">                _serviceCollectionInstallerOverrides.SingleOrDefault(<span class="keyword">override</span> =&gt; <span class="keyword">override</span>.InstallerOverridden == defaultInstaller.GetType());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (installerOverride != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                listWithOverrides.Add(installerOverride);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                listWithOverrides.Add(defaultInstaller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> listWithOverrides;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The way this works is that you create overrides for the service installers that install dependencies that you want to replace with a Test Double. Taking our previous example of the MasstransitServiceInstaller we can create the following:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MasstransitServiceInstallerOverride</span> : <span class="title">IServiceCollectionInstallerOverride</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> FakeEventSender _fakeEventSender;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MasstransitServiceInstallerOverride</span>(<span class="params">FakeEventSender fakeEventSender</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _fakeEventSender = fakeEventSender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureService</span>(<span class="params">IServiceCollection services, IConfiguration configuration</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        services.AddSingleton&lt;IEventSender&gt;(_fakeEventSender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Type InstallerOverridden =&gt; <span class="keyword">typeof</span>(MasstransitServiceInstaller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This would be used as follows</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> serviceCollectionInstallerOverrides = <span class="keyword">new</span> List&lt;IServiceCollectionInstallerOverride&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> MasstransitServiceInstallerOverride(_fakeEventSender),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> serviceCollectionRunner = <span class="keyword">new</span> InMemoryServiceCollectionRunner(serviceCollectionInstallerOverrides);</span><br></pre></td></tr></table></figure>
<p>We create a list of the overrides, and the overrides know which installer they will replace. The InMemoryServiceCollectionRunner then matches up overrides with installers and then runs the override to configure dependencies instead of the normal installer. </p>
<p>This leads us to a version of the InMemoryApi that looks as follows</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryApi</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryApi</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DoubledEventSender = <span class="keyword">new</span> FakeEventSender();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serviceCollectionInstallerOverrides = <span class="keyword">new</span> List&lt;IServiceCollectionInstallerOverride&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> MasstransitServiceInstallerOverride(DoubledEventSender)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> startUp = <span class="keyword">new</span> InMemoryStartup(<span class="keyword">new</span> InMemoryServiceCollectionRunner(serviceCollectionInstallerOverrides));</span><br><span class="line">        <span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartupInstance(startUp);</span><br><span class="line">        <span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line">        Client = server.CreateClient();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IEventSender DoubledEventSender &#123;<span class="keyword">get</span>;<span class="keyword">private</span> <span class="keyword">set</span>;&#125;</span><br><span class="line">    <span class="keyword">public</span> HttpClient Client &#123;<span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This might seem like a lot of complication to achieve more or less what we did in the previous post, but this approach is in my opinion much easier to scale to a large/complex project. When you have possibly 100 dependencies to manage and need to change some of them for in-memory testing this technique makes things easier to follow.</p>
<p>I would be the first to admit that this is an opinionated approach to the problem of structuring your ASP.NET Core projects. If this works for your particular situation then I am glad to have helped.</p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2019/06/11/meetup-design-systems-in-the-real-world-with-react/" data-toggle="tooltip" data-placement="top" title="Meetup: Design Systems in the Real World with React">← Previous Post</a></li><li class="next"><a href="/blog/2019/01/28/testing-an-api-in-memory-in-asp-net-core/" data-toggle="tooltip" data-placement="top" title="Testing an API In Memory in ASP.NET Core">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2019 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>