<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Grunt your deployments too</h1><p class="post-meta">Posted by <a href="/blog/authors/aroyle.html">aroyle</a>, 8 August 2013 · <a href="/blog/categories/JavaScript/" class="tag post-meta">JavaScript</a> · <a href="/blog/categories/Deployment/" class="tag post-meta">Deployment</a> · <a href="/blog/categories/Grunt/" class="tag post-meta">Grunt</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p>We’ve been using <a href="http://www.gruntjs.com" target="_blank" rel="external">Grunt</a> as a build tool for our nodejs apps, and it’s brilliant. It lints, it configures, it minifies, it tests and it packages.</p>
<p>As we move towards getting our first node app into production, we were looking at ways to deploy it. First we thought of <a href="http://www.capistranorb.com" target="_blank" rel="external">Capistrano</a>.</p>
<p><strong><em>Capistrano</em></strong> is a fully featured deployment framework written in ruby and levering rake style tasks. It’s extremely powerful and very robust, plus there is a <a href="https://github.com/loopj/capistrano-node-deploy" target="_blank" rel="external">gem for node deployments</a>. Alas, it was not to be. After half a day of tail chasing and hoop jumping, it occurred to me that there must be an easier way. Capistrano was encouraging me to make my project fit their template, rather than allowing me to configure the deployment to match my project. When I dug down into the Capistrano source, I found that it was just using ssh and sftp to run remote commands and copy files. But we can simplify this process.</p>
<p><strong><em>Grunt</em></strong> has been great so far, so I started looking at deploying directly through grunt. We would be deploying to Ubuntu server boxes, so the only tools necessary are ssh and sftp.</p>
<p>There are Grunt modules for nearly <a href="https://npmjs.org/search?q=grunt" target="_blank" rel="external">everything</a> (linting, minifying, testing, waiting, packaging, shell-exec’ing, tagging, etc.), and rather predictably, sshing (with sftp).</p>
<p><a href="https://github.com/andrewrjones/grunt-ssh" target="_blank" rel="external">Grunt-ssh</a> provides tasks for executing remote ssh commands, and for copying files using ssh. Let’s dive into some code.</p>
<p><strong><em>SSH commands</em></strong></p>
<p>This is going to go over some old ground (available on the Grunt-ssh <a href="https://github.com/andrewrjones/grunt-ssh" target="_blank" rel="external">readme</a>), but we can build up the commands pretty quick.</p>
<p>This is the basic config for executing ssh commands from your Gruntfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">module.exports = function(grunt) &#123;</div><div class="line">  	grunt.initConfig(&#123;</div><div class="line">    	sshexec: &#123;</div><div class="line">      uptime: &#123;</div><div class="line">        command: &quot;uptime&quot;,</div><div class="line">        options: &#123;</div><div class="line">          host: &quot;127.0.0.1&quot;,</div><div class="line">          port: 22</div><div class="line">          username: &quot;myuser&quot;,</div><div class="line">          password: &quot;mypass&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;  </div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  // Load the plugin that provides the &quot;sshexec&quot; task.</div><div class="line">  grunt.loadNpmTasks(&apos;grunt-ssh&apos;);</div><div class="line"></div><div class="line">  // Default task.</div><div class="line">  grunt.registerTask(&apos;default&apos;, [&apos;sshexec:uptime&apos;]);</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>We’ve registered a command, which we can invoke with:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt sshexec:uptime</div></pre></td></tr></table></figure></p>
<p>The Grunt-ssh module also provides the ability to specify multiple host configurations (shared between commands), and to select one at runtime:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">grunt.initConfig(&#123;</div><div class="line">    sshconfig: &#123;</div><div class="line">      qa: &#123;</div><div class="line">        host: &quot;my.qa.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;, </div><div class="line">        password: &quot;password&quot;</div><div class="line">      &#125;,</div><div class="line">      staging: &#123;</div><div class="line">        host: &quot;my.staging.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;,</div><div class="line">        password: &quot;password&quot;</div><div class="line">      &#125;    </div><div class="line">    &#125;,</div><div class="line">    sshexec: &#123;</div><div class="line">      uptime: &#123;</div><div class="line">        command: &quot;uptime&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;  </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>So when we invoke the grunt task, we can specify a config:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt sshexec:uptime --config qa</div></pre></td></tr></table></figure></p>
<p>Or we can set it programmatically (inside the Gruntfile)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt.option(&apos;config&apos;, &apos;qa&apos;);</div></pre></td></tr></table></figure></p>
<p><strong><em>SFTP Tasks</em></strong></p>
<p>Grunt-ssh allows you to upload files via SFTP:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">grunt.initConfig(&#123;</div><div class="line">    sshconfig: &#123;</div><div class="line">      qa: &#123;</div><div class="line">        host: &quot;my.qa.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;, </div><div class="line">        password: &quot;password&quot;,</div><div class="line">        path: &quot;/path/on/server&quot;</div><div class="line">      &#125;,</div><div class="line">      staging: &#123;</div><div class="line">        host: &quot;my.staging.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;,</div><div class="line">        password: &quot;password&quot;,</div><div class="line">        path: &quot;/path/on/server&quot;</div><div class="line">      &#125;    </div><div class="line">    &#125;,</div><div class="line">    sshexec: &#123;</div><div class="line">      uptime: &#123;</div><div class="line">        command: &quot;uptime&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    sftp: &#123;</div><div class="line">      deploy: &#123;</div><div class="line">        files: &#123;</div><div class="line">          &quot;./&quot;: &quot;package/**&quot;</div><div class="line">        &#125;,</div><div class="line">        options: &#123;</div><div class="line">          srcBasePath: &quot;package/&quot;,</div><div class="line">          createDirectories: true</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;  </div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>There are a couple of options here, so let’s break it down:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">files: &#123;</div><div class="line">  &quot;./&quot;: &quot;package/**&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This will copy all files from the “package/“ folder locally. If you want to specify only certain types of files, you can use grunt’s standard <a href="https://github.com/gruntjs/grunt/wiki/grunt.file#globbing-patterns" target="_blank" rel="external">file globbing</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">srcBasePath: &quot;package/&quot;</div></pre></td></tr></table></figure>
<p>Optionally strip off an initial part of the path (without it, files would upload to “/path/on/server/package/“).</p>
<p><strong><em>Putting it all together</em></strong><br>We’ve got all the component parts, now lets put it together (plus a few other cool bits).</p>
<p><em>Note: at the time of writing, there is a bug in Grunt-ssh where the sftp task does not use the shared sshconfig, so if you want the fixed code, use <a href="https://github.com/andyroyle/grunt-ssh" target="_blank" rel="external">my fork</a> (there is a pull request outstanding)</em></p>
<p>This snippet assumes that:</p>
<ul>
<li>You can connect to your deployment server using ssh</li>
<li>You are deploying to /var/www/myapp</li>
<li>You are using <a href="https://github.com/nodejitsu/forever" target="_blank" rel="external">forever</a> to run your app</li>
<li>Your application files are copied to ./package/</li>
</ul>
<p>(but, since we’re just using bash commands, this is easily configurable)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">var dirname = (new Date()).toISOString();</div><div class="line"></div><div class="line">module.exports = function(grunt)&#123;</div><div class="line">  grunt.initConfig(&#123;</div><div class="line">    // our shared sshconfig</div><div class="line">    sshconfig: &#123;</div><div class="line">      qa: &#123;</div><div class="line">        host: &quot;my.qa.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;,</div><div class="line">        password: &quot;password&quot;,</div><div class="line">        path: &quot;/path/on/server&quot;</div><div class="line">      &#125;,</div><div class="line">      staging: &#123;</div><div class="line">        host: &quot;my.staging.server&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;user&quot;,</div><div class="line">        password: &quot;password&quot;,</div><div class="line">        path: &quot;/path/on/server&quot;</div><div class="line">      &#125;,</div><div class="line">      production: &#123;</div><div class="line">        host: &quot;&lt;%= grunt.option(&apos;server&apos;) %&gt;&quot;,</div><div class="line">        port: 22,</div><div class="line">        username: &quot;&lt;%= grunt.option(&apos;username&apos;) %&gt;&quot;,</div><div class="line">        password: &quot;&lt;%= grunt.option(&apos;password&apos;) %&gt;&quot;,</div><div class="line">        path: &quot;/path/on/server&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    // define our ssh commands</div><div class="line">    sshexec: &#123;</div><div class="line">      start: &#123;</div><div class="line">        command: &quot;cd /var/www/myapp/current &amp;&amp; forever start -o /var/www/myapp/current/logs/forever.out -e /var/www/myapp/current/logs/forever.err --append app.js&quot;</div><div class="line">      &#125;,</div><div class="line">      stop: &#123;</div><div class="line">        command: &quot;forever stop app.js&quot;,</div><div class="line">        options: &#123;</div><div class="line">          ignoreErrors: true</div><div class="line">       &#125;</div><div class="line">      &#125;,</div><div class="line">      &apos;make-release-dir&apos;: &#123;</div><div class="line">        command: &quot;mkdir -m 777 -p /var/www/myapp/releases/&quot; + dirname + &quot;/logs&quot;</div><div class="line">      &#125;,</div><div class="line">      &apos;update-symlinks&apos;: &#123;</div><div class="line">        command: &quot;rm -rf /var/www/myapp/current &amp;&amp; ln -s /var/www/myapp/releases/&quot; + dirname + &quot; /var/www/myapp/current&quot;</div><div class="line">      &#125;,</div><div class="line">      &apos;npm-update&apos;: &#123;</div><div class="line">        command: &quot;cd /var/www/myapp/current &amp;&amp; npm update&quot;</div><div class="line">      &#125;,</div><div class="line">      &apos;set-config&apos;: &#123;</div><div class="line">        command: &quot;mv -f /var/www/myapp/current/config/&lt;%= grunt.option(&apos;config&apos;) %&gt;.yml /var/www/myapp/current/config/default.yml&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    // our sftp file copy config</div><div class="line">    sftp: &#123;</div><div class="line">      deploy: &#123;</div><div class="line">        files: &#123;</div><div class="line">          &quot;./&quot;: &quot;package/**&quot;</div><div class="line">        &#125;,</div><div class="line">        options: &#123;</div><div class="line">          srcBasePath: &quot;package/&quot;,</div><div class="line">          createDirectories: true</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  grunt.loadNpmTasks(&apos;grunt-ssh&apos;);</div><div class="line">  grunt.registerTask(&apos;deploy&apos;, [</div><div class="line">    &apos;sshexec:stop&apos;,</div><div class="line">    &apos;sshexec:make-release-dir&apos;,</div><div class="line">    &apos;sshexec:update-symlinks&apos;,</div><div class="line">    &apos;sftp:deploy&apos;,</div><div class="line">    &apos;sshexec:npm-update&apos;,</div><div class="line">    &apos;sshexec:set-config&apos;,</div><div class="line">    &apos;sshexec:start&apos;</div><div class="line">  ]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>It should all make sense, the sshexec is just running remote ssh commands (making directories, starting and stopping using forever etc). Let’s just re-iterate what this is doing:</p>
<ol>
<li><code>sshexec:stop</code>: stops the app (assumes you’re using forever)</li>
<li><code>sshexec:make-release-dir</code>: this will create the folder /var/www/myapp/releases/[current-date-time]</li>
<li><code>sshexec:update-symlinks</code>: this will create a symlink from /var/www/myapp/current to the release folder we just created (this means that rolling back is just a case of changing the symlink back).</li>
<li><code>sftp:deploy</code>: copy the files into place</li>
<li><code>sshexec:npm-update</code>: installs any missing node modules</li>
<li><code>sshexec:set-config</code>: copy the environment configuration into place</li>
<li><code>sshexec:start</code>: start the application using forever, pointing the logs to /var/www/myapp/current/logs/</li>
</ol>
<p><strong><em>Deploying with one command</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt deploy --config qa</div></pre></td></tr></table></figure></p>
<p>Also, if you noticed the <em>production</em> config I specified in that snippet, you’ll see that I didn’t include any host, username or password configs. The <code>grunt.option(&#39;value&#39;)</code> allows us to access the command line switches, which means we don’t have to keep any sensitive passwords in source control; we can specify them on the command line.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grunt deploy --config production --server my.production.server --username user --password password</div></pre></td></tr></table></figure>
<p>There are lots of other solutions to the problem of credentials, but this is by far the simplest. It’s worth remembering the Grunt-ssh uses the ssh2 module, so by default it will look to <code>~/.ssh/</code> for keys when connecting without a password.</p>
<p><strong>But wait, there’s more</strong></p>
<p>Basically any task you can think of is scriptable using grunt (and some combination of tools). Extra things that we’ve added to our deployment process include:</p>
<ul>
<li>Removing the application server from the load-balancer before deploying (and pushing it back when the deployment is complete).</li>
<li>Making a http request to check the health of the service before going live.</li>
<li>Rollback from a single command</li>
</ul>
<p><strong>Oink, Oink …..</strong></p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2013/08/16/grunt-plus-vagrant-equals-acceptance-test-heaven/" data-toggle="tooltip" data-placement="top" title="Grunt + Vagrant = Acceptance Test Heaven">← Previous Post</a></li><li class="next"><a href="/blog/2013/08/07/mapreduce-in-mongodb/" data-toggle="tooltip" data-placement="top" title="MapReduce in MongoDB">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2017 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>