<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Introducing Hobknob: Feature toggling with etcd</h1><p class="post-meta">Posted by <a href="/blog/authors/rtomlinson.html">rtomlinson</a>, 4 September 2014 · <a href="/blog/categories/Hobknob/" class="tag post-meta">Hobknob</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p>The ability to dynamically turn features on/off in software without the need to redeploy code is extremely beneficial. Whether you are trialing a new feature or using branch by abstraction to avoid creating feature branches, the use of feature toggles can aid continuous delivery and provide a mechanism to reduce mean time to resolution when an issue occurs.</p>
<p>With a relatively large engineering department with multiple teams spread across the US and UK the need to manage feature toggles has evolved to the point whereby individual teams have developed their own implementations. Most of these are simple config files.</p>
<p>We decided to unify this effort by providing a central place to store feature toggles, provide a dashboard to be able to turn these toggles on/off and provide language specific clients to integrate into our software components.</p>
<p>The results of this was <a href="https://github.com/opentable/hobknob" target="_blank" rel="noopener">Hobknob</a>.</p>
<h2 id="Why-etcd"><a href="#Why-etcd" class="headerlink" title="Why etcd?"></a>Why etcd?</h2><p>We made the decision to use <a href="https://github.com/coreos/etcd" target="_blank" rel="noopener">etcd</a>. Etcd is “a highly-available key value store for shared configuration” (<a href="https://github.com/coreos/etcd#etcd" target="_blank" rel="noopener">https://github.com/coreos/etcd#etcd</a>). It provides a HTTP API to store and retrieve data. This is what makes it perfect for a feature toggling solution used by multiple components. It means that we didn’t have to write an intermediate API on top of a data store for consumers.</p>
<p>So, for example, to store a feature toggle in etcd:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://127.0.0.1:4001/v2/keys/v1/toggles/restaurant-api/testtoggle -XPUT -d value=&quot;true&quot;</span><br></pre></td></tr></table></figure>
<p>To retrieve a feature toggle:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://127.0.0.1:4001/v2/keys/v1/toggles/restaurant-api/testtoggle</span><br></pre></td></tr></table></figure>
<h2 id="The-Hobknob-Clients"><a href="#The-Hobknob-Clients" class="headerlink" title="The Hobknob Clients"></a>The Hobknob Clients</h2><p>To aid adoption we created, and open sourced, several hobknob clients in multiple languages:</p>
<ul>
<li>NodeJs (NPM) - <a href="https://github.com/opentable/hobknob-client-nodejs" target="_blank" rel="noopener">https://github.com/opentable/hobknob-client-nodejs</a></li>
<li>.NET (Nuget) - <a href="https://github.com/opentable/hobknob-client-net" target="_blank" rel="noopener">https://github.com/opentable/hobknob-client-net</a></li>
<li>Go - <a href="https://github.com/opentable/hobknob-client-go" target="_blank" rel="noopener">https://github.com/opentable/hobknob-client-go</a></li>
<li>Java (Maven) - <a href="https://github.com/opentable/hobknob-client-java" target="_blank" rel="noopener">https://github.com/opentable/hobknob-client-java</a></li>
</ul>
<p>The clients all store a configurable in-memory cache that is periodically updated on a polling interval. They are all read-only and updates only occur on the dashboard where they can be audited.</p>
<p>We decided to create a simple <a href="https://github.com/opentable/hobknob-demo" target="_blank" rel="noopener">demo application</a> to show off how easy it is to use Hobknob in your applications. In order to try the demo you will need to start up Hobknob (see instructions below). The demo app uses the NodeJS client which is as simple as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var client = new Client(&quot;hobknob-demo&quot;, &#123;</span><br><span class="line">  etcdHost: etcdHost,</span><br><span class="line">  etcdPort: etcdPort,</span><br><span class="line">  cacheIntervalMs: 5000</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>In the route definition it uses the client to request the toggle named <em>show-first-and-last-name-input</em> and passes the toggle value through to the view:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var result = hobknobClient.getOrDefault(&apos;show-first-and-last-name-input&apos;, true);</span><br><span class="line">res.render(&apos;server&apos;, &#123;</span><br><span class="line">       			page: &apos;server&apos;,</span><br><span class="line">        		useTwoFieldNameInput: value</span><br><span class="line">      		&#125;);</span><br></pre></td></tr></table></figure>
<p>The view then uses the value to decide whether to display one or two textboxes on the page:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if useTwoFieldNameInput</span><br><span class="line">  input.form-control.demo-input-small(type=&apos;text&apos;, placeholder=&apos;First name&apos;, name=&apos;firstname&apos;)</span><br><span class="line">  input.form-control.demo-input-small(type=&apos;text&apos;, placeholder=&apos;Last name&apos;, name=&apos;lastname&apos;)</span><br><span class="line">else</span><br><span class="line">  input.form-control.demo-input-large(type=&apos;text&apos;, placeholder=&apos;Full name&apos;, name=&apos;fullname&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="The-Hobknob-Dashboard"><a href="#The-Hobknob-Dashboard" class="headerlink" title="The Hobknob Dashboard"></a>The Hobknob Dashboard</h2><p>Hobknob is a NodeJS/AngularJS app. If you want to play with Hobknob the simplest way to get started is to use Vagrant. If you don’t have it installed then get it from <a href="http://www.vagrantup.com/" target="_blank" rel="noopener">http://www.vagrantup.com/</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/opentable/hobknob</span><br><span class="line">cd hobknob</span><br><span class="line">vagrant up</span><br></pre></td></tr></table></figure>
<p>You should now be able to open the dashboard on <a href="http://127.0.0.1:3006" target="_blank" rel="noopener">http://127.0.0.1:3006</a></p>
<p><img src="/images/posts/hobknob-dashboard.png" alt="Hobknob dashboard"></p>
<p>All actions in the dashboard are audited. So when you create or update a toggle by turning it on/off an audit is written for that toggle. Clicking on a toggle in the dashboard takes you to the audit view:</p>
<p><img src="/images/posts/hobknob-audit.png" alt="Hobknob audit"></p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p>By default Hobknob ships with authentication disabled. As a result all auditing will be recorded as “Anonymous”. Currently, we only support Google OAuth. To enable this follow the instructions <a href="https://github.com/opentable/hobknob/blob/master/README.md#configuring-authentication" target="_blank" rel="noopener">here</a></p>
<h3 id="Session-Storage"><a href="#Session-Storage" class="headerlink" title="Session Storage"></a>Session Storage</h3><p>By default Hobknob ships using in-memory session storage. You don’t want to use this when you have a load balanced infrastructure. Hobknob supports both redis and etcd itself as a session store. To use either of these simply npm install the relevent connect middleware (<a href="https://github.com/visionmedia/connect-redis" target="_blank" rel="noopener">connect-redis</a> or <a href="https://github.com/opentable/connect-etcd" target="_blank" rel="noopener">connect-etcd</a>). To learn more follow the instructions <a href="https://github.com/opentable/hobknob/blob/master/README.md#configuring-session" target="_blank" rel="noopener">here</a></p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2014/10/05/puppetconf-2014-part-1/" data-toggle="tooltip" data-placement="top" title="PuppetConf 2014 - Part 1">← Previous Post</a></li><li class="next"><a href="/blog/2014/08/31/testing-puppet-with-beaker-pt-dot-3-testing-roles/" data-toggle="tooltip" data-placement="top" title="Testing Puppet with Beaker pt.3 - Testing Roles">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2019 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>