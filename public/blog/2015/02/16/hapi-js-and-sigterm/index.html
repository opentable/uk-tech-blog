<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Hapi.js and SIGTERM</h1><p class="post-meta">Posted by <a href="/blog/authors/aroyle.html">aroyle</a>, 16 February 2015 · <a href="/blog/categories/Microservices/" class="tag post-meta">Microservices</a> · <a href="/blog/categories/Hapi-js/" class="tag post-meta">Hapi.js</a> · <a href="/blog/categories/SIGTERM/" class="tag post-meta">SIGTERM</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p>When we first stood up our hapi.js APIs, we wrote init scripts to start/stop them. Stopping the server, was simply a case of sending SIGKILL (causing the app to immediately exit).</p>
<p>Whilst this is fine for most cases, if we want our apps to be good Linux citizens, then they should terminate gracefully. Hapi.js has the handy <code>server.stop(...)</code> command (see docs <a href="http://hapijs.com/api#serverstopoptions-callback" target="_blank" rel="noopener">here</a>) which will terminate the server gracefully. It will cause the server to respond to new connections with a 503 (server unavailable), and wait for existing connections to terminate (up to some specified timeout), before stopping the server and allowing the node.js process to exit. Perfect.</p>
<p>This makes our graceful shutdown code really simple:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">process.on(<span class="string">'SIGTERM'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  server.stop(&#123; <span class="attr">timeout</span>: <span class="number">5</span> * <span class="number">1000</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>When we see a SIGTERM, call <code>server.stop()</code>, then once the server has stopped, call <code>process.exit(0)</code>. Easy peasy.</p>
<h3 id="Throw-a-spanner-in-the-works"><a href="#Throw-a-spanner-in-the-works" class="headerlink" title="Throw a spanner in the works"></a>Throw a spanner in the works</h3><p>Whilst <code>server.stop()</code> is really useful, it has the problem that it immediately prevents the server from responding to new requests. In our case, that isn’t particularly desirable. We use service-discovery, which means that the graceful termination of our app should run like this:</p>
<ul>
<li>SIGTERM</li>
<li>Unannounce from Service-Discovery</li>
<li><code>server.stop(...)</code></li>
<li><code>process.exit(0)</code></li>
</ul>
<p>Ideally we want the unannounce to happen before the server starts rejecting connections, in order to reduce the likelihood that clients will hit a server that is shutting down.</p>
<h3 id="Plugins-to-the-rescue"><a href="#Plugins-to-the-rescue" class="headerlink" title="Plugins to the rescue!"></a>Plugins to the rescue!</h3><p>Thanks to hapi.js’s awesome plugin interface (<a href="http://t.co/GDw44SETfS" target="_blank" rel="noopener">shameless self promotion</a>), we can do some magic to make the above possible.</p>
<p>I created a really simple plugin called <a href="https://www.npmjs.com/package/hapi-shutdown" target="_blank" rel="noopener">hapi-shutdown</a> which will handle SIGTERM and then run triggers before calling <code>server.stop(...)</code>.</p>
<p>The idea is that it allows us to run the ‘unannounce’ step, before <code>server.stop(...)</code> is called.</p>
<h3 id="How-to-use-hapi-shutdown"><a href="#How-to-use-hapi-shutdown" class="headerlink" title="How to use hapi-shutdown"></a>How to use hapi-shutdown</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server.register([</span><br><span class="line">  &#123;</span><br><span class="line">    plugin: <span class="built_in">require</span>(<span class="string">'hapi-shutdown'</span>),</span><br><span class="line">    options: &#123;</span><br><span class="line">      serverSpindownTime: <span class="number">5000</span> <span class="comment">// the timeout passed to server.stop(...)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    server.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> </span><br><span class="line">      server.plugins[<span class="string">'hapi-shutdown'</span>].register(&#123;</span><br><span class="line">        taskname: <span class="string">'do stuff'</span>,</span><br><span class="line">        task: <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123; </span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'doing stuff before server.stop is called'</span>); </span><br><span class="line">          done(); </span><br><span class="line">        &#125;,</span><br><span class="line">        timeout: <span class="number">2000</span> <span class="comment">// time to wait before forcibly returning</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>The plugin exposes a <code>.register()</code> function which allows you to register your shutdown tasks. The tasks are named (to prevent multiple registrations), and each task must call the <code>done()</code> function. The <code>timeout</code> parameter is provided so that a task which never completes won’t block the shutdown of the server.</p>
<p> Neat, huh?</p>
<h3 id="Hooking-up-unannounce-using-hapi-shutdown"><a href="#Hooking-up-unannounce-using-hapi-shutdown" class="headerlink" title="Hooking up unannounce using hapi-shutdown"></a>Hooking up unannounce using hapi-shutdown</h3><p>We now have a place to register our ‘unannounce’ task. Our service-discovery code is wrapped in another plugin, which means we can use <code>server.dependency(...)</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inside the plugin's register function</span></span><br><span class="line"></span><br><span class="line">server.dependency(<span class="string">'hapi-shutdown'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">_, cb</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> err = server.plugins[<span class="string">'hapi-shutdown'</span>].register(&#123;</span><br><span class="line">    taskname: <span class="string">'discovery-unannounce'</span>,</span><br><span class="line">    task: <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">      discovery.unannounce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        done();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    timeout: <span class="number">10</span> * <span class="number">1000</span></span><br><span class="line">  &#125;);</span><br><span class="line"> </span><br><span class="line">  cb(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>server.dependency(...)</code> allows us to specify that this plugin relies on another plugin (or list of plugins). If the dependent plugin is not registered before the server starts, then an exception is thrown.</p>
<p>Handily, <code>server.dependency(...)</code> also takes a callback function, which is invoked after all the dependencies have been registered, which means that you don’t need to worry about ordering inside your <code>server.register(...)</code> code.</p>
<p>This allows our unannounce code to be decoupled from the actual business of shutting down the server.</p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2015/03/05/the-dns-abc/" data-toggle="tooltip" data-placement="top" title="The DNS ABC">← Previous Post</a></li><li class="next"><a href="/blog/2015/02/09/dismantling-the-monolith-microsites-at-opentable/" data-toggle="tooltip" data-placement="top" title="Dismantling the monolith - Microsites at Opentable">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2019 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>